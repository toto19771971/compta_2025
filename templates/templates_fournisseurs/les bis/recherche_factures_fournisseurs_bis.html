<!DOCTYPE html>
<html lang="fr">
<head>
    <link rel="stylesheet" href="static/style_fournisseurs.css?v=3" type="text/css" />
  <meta charset="UTF-8">
  <title>Prototype Intégré</title>
  <style>
    /* Corps de page */
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
    }
    /* Barre d’actions */
    .toolbar { display: flex; justify-content: center; gap: 10px; margin-bottom: 30px; }
    .toolbar button { border: none; padding: 10px 20px; font-size: 16px; border-radius: 5px; cursor: pointer; }
    .toolbar button:hover { }

    /* Grid principal */
    .grid-container { display: flex; gap: 40px; }
    .form-left,
    .form-right {
      display: grid;
      grid-template-columns: 180px 1fr;
      row-gap: 10px;
      column-gap: 10px;
      flex: 1;
    }
    .form-left label,
    .form-right label { align-self: center; }
    .form-left input,
    .form-right input,
    .form-right textarea { width: 33%; padding: 6px; box-sizing: border-box; height: 32px; }

    /* Styles tables */
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #888; padding: 8px; text-align: left; }
    th { }

    /* Boutons + Ajouter */
    .add-btn { border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; margin: 8px 0; display: inline-block; }

    /* Total TTC : aligné à droite */
    .total-ttc {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: bold;
      font-size: 20px;
      padding: 8px;
      border: 1px solid #888;
    }
    .total-ttc input {
      width: 120px;
      padding: 6px;
      box-sizing: border-box;
      font-size: 18px;
    }

    /* Suppression des ascenseurs sur inputs number */
    input[type=number]::-webkit-inner-spin-button,
    input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
    input[type=number] { -moz-appearance: textfield; }
  </style>
</head>
<body class="suppliers-body" class="suppliers-body">

  <!-- Barre d’actions -->
  <div class="toolbar">
    <button class="action-btn" onclick="location.href='/comptabilite_fournisseurs'">Retour</button>
    <button class="action-btn" onclick="window.open('https://fr.wikipedia.org','_blank')">Aide</button>
    <button class="action-btn" onclick="window.print()">Imprimer</button>
    <button class="action-btn" id="btn-create-facture" type="button">Créer</button>
    <button class="action-btn" id="btn-update" type="button">MAJ</button>
    <button class="action-btn" onclick="location.href='/liste_factures_fournisseurs'">Liste</button>
    <button class="action-btn" id="btn-clear" type="button">Vider</button>
  </div>

  <!-- Formulaire unique -->
  <form id="factureContainer">

    <!-- Inputs statiques -->
    <div class="grid-container">
      <div class="form-left">
        <label for="fournisseur">Fournisseur :</label>
        <input id="fournisseur" name="Fournisseur" type="text" list="liste_noms" autocomplete="off" placeholder="Tapez le fournisseur…" />
        <datalist id="liste_noms">
          {% for f in df_fournisseurs %}
            <option value="{{ f['Nom du fournisseur'] }}"></option>
          {% endfor %}
        </datalist>

        <label for="num_compte_fournisseur">No compte Fournisseur :</label>
        <input id="num_compte_fournisseur" name="No compte Fournisseur" type="text">

        <label for="condition_paiement">Condition de paiement :</label>
        <input id="condition_paiement" name="Condition de paiement" type="text">

        <label for="date_facture">Date de facture :</label>
        <input id="date_facture" name="Date de facture" type="date">

        <label for="date_echeance">Date échéance :</label>
        <input id="date_echeance" name="Date échéance" type="date">

        <label for="date_paiement">Date paiement prévue :</label>
        <input id="date_paiement" name="Date paiement prévue" type="date">

        <label for="periode">Période (MM/YYYY) :</label>
        <input id="periode" name="Période" type="month">

        <label for="montant">Montant :</label>
        <input id="montant" name="Montant" type="text">

        <label for="balance">Balance :</label>
        <input id="balance" name="Balance" type="text">
      </div>

      <div class="form-right">
        <label for="num_facture">No de facture :</label>
        <input id="num_facture" name="No de facture" type="text">

        <label for="num_commande">No de commande :</label>
        <input id="num_commande" name="No de commande" type="text">

        <label for="statut">Statut :</label>
        <input id="statut" name="Statut" type="text">
      </div>
    </div>

    <!-- Table lignes facture -->
    <table id="invoice-table">
      <thead>
        <tr>
          <th>No de compte</th>
          <th>Libellé du compte</th>
          <th>Quantité</th>
          <th>Unité</th>
          <th>Montant</th>
        </tr>
      </thead>
      <tbody id="invoice-body">
        <tr>
          <td><input name="compte[]"        type="text" /></td>
          <td><input name="libelle_compte[]" type="text" /></td>
          <td><input name="quantite[]"      type="number" step="1" inputmode="numeric" /></td>
          <td><input name="unite[]"         type="number" step="1" inputmode="numeric" /></td>
          <td><input name="montant[]"       type="number" step="0.01" inputmode="decimal" /></td>
        </tr>
      </tbody>
    </table>
    <button class="action-btn" type="button" class="add-btn" id="add-line-invoice">+ Ajouter une ligne</button>

    <!-- Table lignes TVA -->
    <table id="tax-table">
      <thead>
        <tr>
          <th>No de compte TVA</th>
          <th>Libellé TVA</th>
          <th>Taux TVA</th>
          <th>Montant TVA</th>
        </tr>
      </thead>
      <tbody id="tax-body">
        <tr>
          <td><input name="compte_tva[]"  type="text" /></td>
          <td><input name="libelle_tva[]" type="text" /></td>
          <td><input name="taux_tva[]"    type="number" step="0.01" inputmode="decimal" /></td>
          <td><input name="montant_tva[]" type="number" step="0.01" inputmode="decimal" /></td>
        </tr>
      </tbody>
      <tfoot>
        <tr>
          <td colspan="3" style="border:none;"></td>
          <td colspan="1" class="total-ttc">
            Total TTC : <input id="total_ttc" name="total_ttc" readonly />
          </td>
        </tr>
      </tfoot>
    </table>
    <button class="action-btn" type="button" class="add-btn" id="add-line-tax">+ Ajouter une ligne</button>

    <!-- Templates -->
    <template id="tpl-invoice-line">
      <tr>
        <td><input name="compte[]"        type="text" /></td>
        <td><input name="libelle_compte[]" type="text" /></td>
        <td><input name="quantite[]"      type="number" step="1" inputmode="numeric" /></td>
        <td><input name="unite[]"         type="number" step="1" inputmode="numeric" /></td>
        <td><input name="montant[]"       type="number" step="0.01" inputmode="decimal" /></td>
      </tr>
    </template>

    <template id="tpl-tax-line">
      <tr>
        <td><input name="compte_tva[]"  type="text" /></td>
        <td><input name="libelle_tva[]" type="text" /></td>
        <td><input name="taux_tva[]"    type="number" step="0.01" inputmode="decimal" /></td>
        <td><input name="montant_tva[]" type="number" step="0.01" inputmode="decimal" /></td>
      </tr>
    </template>

  </form>
  

  <!-- Calcul et ajout de lignes -->
  <script>
  
  
   
  




    document.addEventListener('DOMContentLoaded', () => {
      const invBody   = document.getElementById('invoice-body');
      const taxBody   = document.getElementById('tax-body');
      const totalEl   = document.getElementById('total_ttc');
      const tplInv    = document.getElementById('tpl-invoice-line').content;
      const tplTax    = document.getElementById('tpl-tax-line').content;

      function recalcInvoiceRow(tr) {
        const q = parseInt(tr.querySelector('[name="quantite[]"]').value, 10) || 0;
        const u = parseInt(tr.querySelector('[name="unite[]"]').value, 10)    || 0;
        tr.querySelector('[name="montant[]"]').value = (q * u).toFixed(2);
      }

      function recalcTotal() {
        let sum = 0;
        invBody.querySelectorAll('tr').forEach(tr => {
          sum += parseFloat(tr.querySelector('[name="montant[]"]').value) || 0;
        });
        taxBody.querySelectorAll('tr').forEach(tr => {
          sum += parseFloat(tr.querySelector('[name="montant_tva[]"]').value) || 0;
        });
        totalEl.value = sum.toFixed(2);
      }

      // Ajout de lignes
      document.getElementById('add-line-invoice').addEventListener('click', () => {
        invBody.appendChild(document.importNode(tplInv, true));
        recalcTotal();
      });
      document.getElementById('add-line-tax').addEventListener('click', () => {
        taxBody.appendChild(document.importNode(tplTax, true));
        recalcTotal();
      });

      // Recalcul automatique
      invBody.addEventListener('input', e => {
        if (e.target.matches('[name="quantite[]"], [name="unite[]"]')) {
          recalcInvoiceRow(e.target.closest('tr'));
          recalcTotal();
        }
      });
      taxBody.addEventListener('input', e => {
        if (e.target.matches('[name="montant_tva[]"]')) {
          recalcTotal();
        }
      });

      recalcTotal();
    });
  

  <!-- Autoremplissage du fournisseur -->
  
    document.getElementById('fournisseur').addEventListener('input', async function() {
      const v = this.value.trim();
      if (!v) return;
      const res = await fetch('/autocomplete_factures_fournisseurs?query=' + encodeURIComponent(v));
      if (!res.ok) return;
      const arr = await res.json();
      const f   = arr.find(x => x['Nom du fournisseur'] === v) || arr[0];
      if (!f) return;

      document.getElementById('num_compte_fournisseur').value = f['Compte à créditer'];
      document.getElementById('condition_paiement').value    = f['Délai de paiement'];

      const invRow = document.querySelector('#invoice-body tr:last-child');
      invRow.querySelector('[name="compte[]"]').value = f['Compte à débiter'];

      const taxRow = document.querySelector('#tax-body tr:last-child');
      taxRow.querySelector('[name="compte_tva[]"]').value  = f['Compte TVA'];
      taxRow.querySelector('[name="taux_tva[]"]').value    = f['Taux TVA 1'];
    });
  

  
    document.getElementById('btnCreate').addEventListener('click', async () => {
          const formEl = document.getElementById('invoice-form');

          // ── LOG POINT 1 : Vérifier le contenu du form ──
          // But : s’assurer que TOUT input (statique + dynamique) est dans le form
          const allInputs = formEl.querySelectorAll('input');
          console.log(
            '%c[LOG 1] Total inputs INSIDE <form>:', 
            ' padding:2px;',
            allInputs.length, allInputs
          );
          // But : FormData ne serialise que les inputs avec un name
          const namedInputs = Array.from(allInputs).filter(i => i.name);
          console.log(
            '%c[LOG 1] Inputs WITH name (=> sérialisés):', 
            ' padding:2px;',
            namedInputs.length, namedInputs
          );
          // Attendu : namedInputs.length === allInputs.length

          // ── LOG POINT 2 : Création et inspection du FormData ──
          const formData = new FormData(formEl);
          // But : voir exactement ce que FormData a capturé
          console.table(
            Array.from(formData.entries()),
            ['0: key', '1: value']
          );
          // Attendu : on doit voir TOUTES vos paires clé=valeur, 
          // y compris compte[], qty[], unit_price[]…

          // ── LOG POINT 3 : Afficher la payload brute avant fetch ──
          // (nécessite browser récent supportant FormData.prototype.get)
          if (typeof formData.get === 'function') {
            console.log(
              '%c[LOG 3] Vérif valeurs exemple (invoice_lines[0][description]):',
              '',
              formData.get('invoice_lines[0][description]')
            );
          }

          // ── ENVOI ──
          try {
            const res = await fetch('/ajouter_facture', {
              method: 'POST',
              body: formData
            });
            const txt = await res.text();
            console.log(
              '%c[LOG FETCH] Statut:', 
              ``, 
              res.status, txt
            );
          } catch (err) {
            console.error('%c[LOG FETCH] Erreur réseau:', '', err);
          }
        });
     
  

  
  
    document.getElementById('btn-clear').addEventListener('click', () => {
      const formEl = document.getElementById('factureContainer');
      formEl.reset();
      document.getElementById('invoice-body').innerHTML = '';
      document.getElementById('tax-body').innerHTML     = '';
      document.getElementById('invoice-body').appendChild(document.importNode(tplInv, true));
      document.getElementById('tax-body').appendChild(document.importNode(tplTax, true));
    });
  </script>  

</body>
</html>








