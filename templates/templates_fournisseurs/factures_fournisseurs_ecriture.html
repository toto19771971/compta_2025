{%- if data is not defined -%}
  {%- set data = {} -%}
{%- endif -%}




<!DOCTYPE html>
<html lang="fr">
<head>
    <link rel="stylesheet" href="{{ url_for('static', filename='style_fournisseurs.css') }}" type="text/css" />

  <meta charset="UTF-8">
  <title>Prototype Int√©gr√©</title>
  <style>
    /* Corps de page */
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
    }
    /* Barre d‚Äôactions */
    .toolbar { display: flex; justify-content: center; gap: 10px; margin-bottom: 30px; }
    .toolbar button { border: none; padding: 10px 20px; font-size: 16px; border-radius: 5px; cursor: pointer; }
    

    /* Grid principal */
    .grid-container { display: flex; gap: 40px; }
    .form-left,
    .form-right {
      display: grid;
      grid-template-columns: 180px 1fr;
      row-gap: 10px;
      column-gap: 10px;
      flex: 1;
      align-items: center;
      flex: 1;
    }
  
    .form-left label, .form-right label { align-self: center; }
    .form-left input,
    .form-right input,
    .form-right textarea { width: 33%; padding: 6px; box-sizing: border-box; height: 32px; }

    /* Styles tables */
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #888; padding: 8px; text-align: left; }

    /* Boutons + Ajouter */
    .add-btn { border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; margin: 8px 0; display: inline-block; }

    /* Total TTC : align√© √† droite */
    .total-ttc {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: bold;
      font-size: 20px;
      padding: 8px;
      border: 1px solid #888;
    }
    .total-ttc input {
      width: 120px;
      padding: 6px;
      box-sizing: border-box;
      font-size: 18px;
    }

    /* Suppression des ascenseurs sur inputs number */
    input[type=number]::-webkit-inner-spin-button,
    input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
    input[type=number] { -moz-appearance: textfield; }
  </style>
</head>
<body class="suppliers-body">

  <!-- Barre d‚Äôactions -->
  <div class="toolbar">
    <button class="action-btn" onclick="location.href='/comptabilite_fournisseurs'">Retour</button>
    <button class="action-btn" onclick="window.open('https://fr.wikipedia.org','_blank')">Aide</button>
    <a class="toolbar" href="{{ url_for('factures_fournisseurs_search') }}">Rechercher</a>
    <button class="action-btn" id="btn-create-facture" type="button">Cr√©er</button>
    <button class="action-btn" id="btn-update" type="button">MAJ</button>
    <button class="action-btn" onclick="location.href='/liste_factures_fournisseurs'">Liste</button>
    <button class="toolbar"onclick="location.href='/grand_livre_full'"> Publier le GL</button>
    <button class="action-btn" id="btn-double-create" >Double cr√©ation</button>
    <button class="action-btn" id="btn-clear" type="button">Vider</button>
  </div>

  <!-- Formulaire unique -->
  <form id="factureContainer" method="post" action="/creer_et_publier">
  <input type="hidden" name="module" value="factures_fournisseurs">
  <input type="hidden" name="orig_id" value="{{ data.orig_id | default('') }}">
    
    <!-- Inputs statiques -->
    <div class="grid-container">
      <div class="form-left">
        <label for="fournisseur">Fournisseur :</label>
        <input id="fournisseur" name="Nom du fournisseur" type="text" list="liste_noms" autocomplete="off" placeholder="Tapez le fournisseur‚Ä¶" value="{{ fournisseur|default('') }}" />
        <datalist id="liste_noms">
          {% for f in df_fournisseurs %}
            <option value="{{ f['Nom du fournisseur'] }}"></option>
          {% endfor %}
        </datalist>

        <label for="num_compte_fournisseur">No compte Fournisseur :</label>
        <input id="num_compte_fournisseur" name="No compte Fournisseur" type="text" value="{{ compte_fournisseur|default('') }}">

        <label for="condition_paiement">Condition de paiement :</label>
        <input id="condition_paiement" name="Condition de paiement" type="text" value="{{ condition_paiement|default('') }}">

        <label for="date_facture">Date de facture :</label>
        <input id="date_facture" name="Date de facture" type="date" value="{{ date_facture|default('') }}">

        <label for="date_echeance">Date √©ch√©ance :</label>
        <input id="date_echeance" name="Date √©ch√©ance" type="date" value="{{ date_echeance|default('') }}">

        <label for="date_paiement">Date paiement pr√©vue :</label>
        <input id="date_paiement" name="Date paiement pr√©vue" type="date" value="{{ date_paiement_prevue|default('') }}">

        <label for="periode">P√©riode (MM/YYYY) :</label>
        <input id="periode" name="P√©riode" type="month" value="{{ periode|default('') }}">

        <label for="montant">Montant :</label>
        <input id="montant" name="Montant" type="text" value="{{ montant|default('') }}">

        <label for="balance">Balance :</label>
        <input id="balance" name="Balance" type="text" value="{{ balance|default('') }}">
      </div>

      <div class="form-right">
        <label for="num_facture">No de facture :</label>
        <input id="num_facture" name="No de facture" type="text" value="{{ no_facture|default('') }}">

        <label for="num_commande">No de commande :</label>
        <input id="num_commande" name="No de commande" type="text" value="{{ no_commande|default('') }}">

        <label for="statut">Statut :</label>
        <input id="statut" name="Statut" type="text" value="{{ statut|default('') }}">
      </div>
    </div>

    <!-- Table lignes facture -->
    <table id="invoice-table">
      <thead>
        <tr>
          <th>No de compte</th>
          <th>Libell√© du compte</th>
          <th>Quantit√©</th>
          <th>Unit√©</th>
          <th>Base HT</th>
        </tr>
      </thead>
      <tbody id="invoice-body">
        <tr>
          <td><input name="compte[]" type="text" value="{{ no_compte|default('') }}"/></td>
          <td><input name="libelle_compte[]" type="text" value="{{ libelle_compte|default('') }}"/></td>
          <td><input name="quantite[]" type="number" step="1" inputmode="numeric" value="{{ quantite|default('') }}"/></td>
          <td><input name="unite[]" type="number" step="1" inputmode="numeric" value="{{ unite|default('') }}"/></td>
          <td><input name="base_ht[]" type="number" step="0.01" inputmode="decimal" value="{{ somme_brute|default('') }}"/></td>
        </tr>
      </tbody>
    </table>
    <button class="action-btn" type="button" class="add-btn" id="add-line-invoice">+ Ajouter une ligne</button>

    <!-- Table lignes TVA -->
    <table id="tax-table">
      <thead>
        <tr>
          <th>No de compte TVA</th>
          <th>Libell√© TVA</th>
          <th>Taux TVA</th>
          <th>Montant TVA</th>
        </tr>
      </thead>
      <tbody id="tax-body">
        <tr>
          <td><input name="compte_tva[]" type="text" value="{{ no_compte_tva|default('') }}"/></td>
          <td><input name="libelle_tva[]" type="text" value="{{ libelle_tva|default('') }}"/></td>
          <td><input name="taux_tva[]" type="number" step="0.01" inputmode="decimal" value="{{ taux_tva|default('') }}"/></td>
          <td><input name="montant_tva[]" type="number" step="0.01" inputmode="decimal" value="{{ montant_tva|default('') }}"/></td>
        </tr>
      </tbody>
      <tfoot>
        <tr>
          <td colspan="3" style="border:none;"></td>
          <td colspan="1" class="total-ttc">
            Total TTC : <input id="total_ttc" name="total_ttc" readonly value="{{ total_ttc|default('') }}"/>
          </td>
        </tr>
      </tfoot>
    </table>
    <button class="action-btn" type="button" class="add-btn" id="add-line-tax">+ Ajouter une ligne</button>

    <!-- Templates -->
    <template id="tpl-invoice-line">
      <tr>
        <td><input name="compte[]" type="text" /></td>
        <td><input name="libelle_compte[]" type="text" /></td>
        <td><input name="quantite[]" type="number" step="1" inputmode="numeric" /></td>
        <td><input name="unite[]" type="number" step="1" inputmode="numeric" /></td>
        <td><input name="base_ht[]" type="number" step="0.01" inputmode="decimal" /></td>
      </tr>
    </template>

    <template id="tpl-tax-line">
      <tr>
        <td><input name="compte_tva[]" type="text" /></td>
        <td><input name="libelle_tva[]" type="text" /></td>
        <td><input name="taux_tva[]" type="number" step="0.01" inputmode="decimal" /></td>
        <td><input name="montant_tva[]" type="number" step="0.01" inputmode="decimal" /></td>
      </tr>
    </template>

  </form>
  

  <!-- Calcul et ajout de lignes -->
  <script>

    document.addEventListener('DOMContentLoaded', () => {
      const invBody   = document.getElementById('invoice-body');
      const taxBody   = document.getElementById('tax-body');
      const totalEl   = document.getElementById('total_ttc');
      const tplInv    = document.getElementById('tpl-invoice-line').content;
      const tplTax    = document.getElementById('tpl-tax-line').content;

      function recalcInvoiceRow(tr) {
        const q = parseInt(tr.querySelector('[name="quantite[]"]').value, 10) || 0;
        const u = parseInt(tr.querySelector('[name="unite[]"]').value, 10)    || 0;
        tr.querySelector('[name="base_ht[]"]').value = (q * u).toFixed(2);
      }

      function recalcTotal() {
        let sum = 0;
        invBody.querySelectorAll('tr').forEach(tr => {
          sum += parseFloat(tr.querySelector('[name="base_ht[]"]').value) || 0;
        });
        taxBody.querySelectorAll('tr').forEach(tr => {
          sum += parseFloat(tr.querySelector('[name="montant_tva[]"]').value) || 0;
        });
        totalEl.value = sum.toFixed(2);
      }

      // Ajout de lignes
      document.getElementById('add-line-invoice').addEventListener('click', () => {
        invBody.appendChild(document.importNode(tplInv, true));
        recalcTotal();
      });
      document.getElementById('add-line-tax').addEventListener('click', () => {
        taxBody.appendChild(document.importNode(tplTax, true));
        recalcTotal();
      });

      
      document.addEventListener('DOMContentLoaded', () => {
        invBody.appendChild(document.importNode(tplInv, true));
        taxBody.appendChild(document.importNode(tplTax, true));
        recalcTotal();
      });
    


      // Recalcul automatique
      invBody.addEventListener('input', e => {
        if (e.target.matches('[name="quantite[]"], [name="unite[]"]')) {
          recalcInvoiceRow(e.target.closest('tr'));
          recalcTotal();
        }
      });
      taxBody.addEventListener('input', e => {
        if (e.target.matches('[name="montant_tva[]"]')) {
          recalcTotal();
        }
      });

      recalcTotal();
    });
  

  <!-- Autoremplissage du fournisseur -->
  
    document.getElementById('fournisseur').addEventListener('input', async function() {
      const v = this.value.trim();
      if (!v) return;
      const res = await fetch('/autocomplete_factures_fournisseurs?query=' + encodeURIComponent(v));
      if (!res.ok) return;
      const arr = await res.json();
      const f   = arr.find(x => x['Nom du fournisseur'] === v) || arr[0];

      console.log("DEBUG ‚Äì objet f retourn√© par autocomplete :", f);
      
      if (!f) return;

      // Mets √† jour les champs g√©n√©raux
      document.getElementById('num_compte_fournisseur').value = f['Compte √† cr√©diter'];
      document.getElementById('condition_paiement').value    = f['D√©lai de paiement'];

      // Ligne ‚Äúfacture‚Äù (premier <tr>)
      const invRow = document.querySelector('#invoice-body tr');
      invRow.querySelector('[name="compte[]"]').value       = f['Compte √† d√©biter'];

      // Ligne ‚ÄúTVA‚Äù (premier <tr>)
      const taxRow = document.querySelector('#tax-body tr');
      taxRow.querySelector('[name="compte_tva[]"]').value   = f['Compte TVA'];
      taxRow.querySelector('[name="taux_tva[]"]').value     = f['Taux TVA 1'];
    });


  
  
    document.getElementById('btn-create-facture').addEventListener('click', async e => {
      e.preventDefault();
      const formEl = document.getElementById('factureContainer');
      const formData = new FormData(formEl);
      console.log("üì§ Donn√©es envoy√©es :", [...formData.entries()]);

      const res  = await fetch('/ajouter_facture', { method: 'POST', body: formData });
      const json = await res.json();
      alert(json.message || 'Facture cr√©√©e !');

      formEl.reset();
      document.getElementById('invoice-body').innerHTML = '';
      document.getElementById('tax-body').innerHTML     = '';
      document.getElementById('invoice-body').appendChild(document.importNode(tplInv, true));
      document.getElementById('tax-body').appendChild(document.importNode(tplTax, true));
    });
  



    

      


  // (2) R√©installe ton listener ‚ÄúVider‚Äù tel quel :
      document.getElementById('btn-clear').addEventListener('click', () => { 
        const formEl = document.getElementById('factureContainer');
        formEl.reset();
        const invBody = document.getElementById('invoice-body');
        const taxBody = document.getElementById('tax-body');
        // Vide puis recr√©e **exactement** une ligne de chaque tableau
        invBody.innerHTML = '';
        taxBody.innerHTML = '';
        invBody.appendChild(document.importNode(tplInv, true));
        taxBody.appendChild(document.importNode(tplTax, true));
      });



      document.getElementById('btn-double-create')
            .addEventListener('click', async e => {
              e.preventDefault();
              const formEl = document.getElementById('factureContainer');
              const formData = new FormData(formEl);
              // Envoie vers la nouvelle route
              const res = await fetch('/double_creation', { method: 'POST', body: formData });
              if (!res.ok) {
                alert('Erreur double cr√©ation');
                return;
              }
              // On r√©cup√®re le JSON contenant num_ecriture
              const { num_ecriture } = await res.json();
              // Puis on redirige
              alert('La double cr√©ation est bien r√©ussie (n¬∞' + num_ecriture + ')');
;
            });

          
          



  </script>  

</body>
</html>
