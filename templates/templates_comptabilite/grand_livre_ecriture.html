<!DOCTYPE html>
<html lang="fr">
<head>
    <link rel="stylesheet" href="static/style_comptabilite.css?v=3" type="text/css" />
    <meta charset="UTF-8">
    <title>Nouvelle Ã©criture manuelle au journal</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='style_comptabilite.css') }}">
    <style>
      body { margin: 0; padding: 0; font-family: Arial, sans-serif; background: #f5f5f5;}
      .toolbar { position: fixed; top: 0; left: 50%; transform: translateX(-50%);
        display: flex; flex-wrap: wrap; justify-content: center; gap: 16px; background: #fff;
        padding: 12px 0; box-shadow: 0 2px 8px rgba(0,0,0,0.1); z-index: 1000;
        width: 100%; max-width: 1200px;}
      .toolbar a, .toolbar button { flex: 0 1 auto; padding: 10px 20px; background: #ccffcc;
        color: #0e130e; text-decoration: none; font-weight: bold; border-radius: 8px;
        border: 0; cursor: pointer;}
      .toolbar a { text-decoration: none;}
      .container { background: #fff; width: 95%; max-width: 1200px; margin: 0 auto;
        padding: 30px; padding-top: 100px; border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);}
      h1 { text-align: center; font-size: 1.8em; margin-bottom: 30px;}
      .form-section { margin-bottom: 30px;}
      .row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;}
      .form-group { display: flex; align-items: center;}
      .form-group label { width: 180px; font-weight: bold;}
      .form-group input, .form-group select { padding: 6px; font-size: 1em;}
      .form-group-right { display: flex; align-items: center;}
      .form-group-right label { margin-right: 8px; font-weight: bold;}
      .form-group-right select { width: 100px; padding: 8px; background: #ccffcc; color: #0e130e;
        border: 1px solid #ccc; border-radius: 4px;}
      table { width: 100%; border-collapse: collapse; margin-top: 10px;}
      th, td { border: 1px solid #4a90e2; padding: 8px; font-size: 0.95em;}
      th { background: #e8f1fb; text-align: center;}
      .col-compte   { width: 30%;}
      .col-intitule { width: 40%;}
      .col-debit    { width: 15%; text-align: right;}
      .col-credit   { width: 15%; text-align: right;}
      .accounts-col select { width: 100%; padding: 6px; font-size: 1em;}
      .add-row { display: inline-block; margin: 20px 0; padding: 8px 12px; background: #007bff; color: white; border-radius: 4px; cursor: pointer; font-weight: bold; border: none; align-items: left;}
      #total-table { width: 100%; border-collapse: collapse; margin-top: 20px;}
      #ecritures_table td input, .total-row td { background: #fff !important; border: 1px solid #000 !important;}
      #total-table td { border: 1px solid #4a90e2; padding: 8px; font-weight: bold;}
      #total-table td:first-child { text-align: left; background: #fff !important; border: 1px solid #000 !important;}
      #total-table td:nth-child(2) { border-left: none; border-right: none; background: #fff !important; border: 1px solid #000 !important;}
      #ecritures_table td:nth-child(4), #ecritures_table td:nth-child(5), #total-table td:nth-child(4), #total-table td:nth-child(5) { text-align: left; border: 1px solid #000 !important;}
      #ecritures_table td:nth-child(2), #ecritures_table th:nth-child(2) { text-align: center;}
      .total-row td { background: #fff !important; border: 1px solid #5717b8 !important;}
      #total-table #total_debit, #total-table #total_credit { background: #fff !important; border: 1px solid #000 !important;}
      #total-table td#total_debit, #total-table td#total_credit { background: #fff !important; border: 1px solid #000 !important;}
      #ecritures_table td select, #ecritures_table td input { height: 2.8em; box-sizing: border-box;}
    </style>
</head>
<body class="comptabilite compta-body">

  <script id="accounts-data" type="application/json">
    {{ accounts | default([]) | tojson | safe }}
  </script>

  <div class="toolbar">
    <a href="{{ url_for('grand_livre_accueil') }}">RETOUR</a>
    <a href="#">AIDE</a>
    <a href="#">IMPRIMER</a>
    <button class="action-btn" type="button" id="btn-create">CRÃ‰ER</button>
    <a href="#">SUPPRIMER</a>
    <a href="#">TÃ‰LÃ‰CHARGER EN PDF</a>
    <button type="button" onclick=window.location.href="{{ url_for('grand_livre_full') }}">
      Grand Livre
    </button>
  </div>

  <div class="container">

    <h1>Nouvelle Ã©criture manuelle au journal</h1>
    <form method="post" action="{{ url_for('submit_ecriture_man') }}">
      <div class="form-section">
        <div class="row">
          <div class="form-group">
            <label for="date_comptabilisation">Date de comptabilisation :</label>
            <input
              type="date"
              id="date_comptabilisation"
              name="date_comptabilisation"
              value="{{ date_comptabilisation }}">
          </div>
          <div class="form-group-right">
            <label for="memoriser_choice">MÃ©moriser :</label>
            <select id="memoriser_choice" name="memoriser_choice">
              <option value="non" selected>Non</option>
              <option value="oui">Oui</option>
            </select>
          </div>
        </div>
        <div class="row">
          <div class="form-group">
            <label for="periode">PÃ©riode :</label>
            <input
              type="month"
              id="periode"
              name="periode"
              value="{{ periode }}">
          </div>
        </div>
        <div class="row">
          <div class="form-group">
            <label for="libelle">LibellÃ© :</label>
            <input
              type="text"
              id="libelle"
              name="libelle"
              placeholder="Texte libre"
              value="{{ libelle }}">
          </div>
        </div>
      </div>

      <div class="form-section">
        <br><br><br>
        <table id="ecritures_table">
          <colgroup>
            <col class="col-compte">
            <col class="col-intitule">
            <col class="col-debit">
            <col class="col-credit">
          </colgroup>
          <thead>
            <tr>
              <th>NÂ° compte</th>
              <th>IntitulÃ© du compte</th>
              <th>Montant DÃ©bit</th>
              <th>Montant CrÃ©dit</th>
            </tr>
          </thead>
          <tbody>
            {% if lignes %}
              {# On prÃ©remplit toutes les lignes depuis la base #}


              {% for ligne in lignes %}
              <tr>
                <td class="accounts-col">
                  <select name="num_compte[]" onchange="onAccountChange(this)">
                    <option value="">_SÃ©lectionner_</option>
                    {% for account in accounts %}
                      <option
                        value="{{ account.num_compte }}"
                        data-intitule="{{ account.intitule }}"
                        {% if account.num_compte == ligne.num_compte|string %}selected{% endif %}>
                        {{ account.num_compte }} â€“ {{ account.intitule }}
                      </option>
                    {% endfor %}
                  </select>
                </td>
                <td>
                  <input
                    type="text"
                    name="intitule[]"
                    readonly
                    value="{{ ligne.intitule }}"
                    style="background:#fff; border:1px solid #ccc;">
                </td>
                <td>
                  <input
                    type="text"
                    name="debit[]"
                    placeholder="0,00"
                    value="{{ '%.2f' % ligne.debit if ligne.debit is not none else '' }}"
                    style="background:#fff; border:1px solid #ccc; text-align:right;">
                </td>
                <td>
                  <input
                    type="text"
                    name="credit[]"
                    placeholder="0,00"
                    value="{{ '%.2f' % ligne.credit if ligne.credit is not none else '' }}"
                    style="background:#fff; border:1px solid #ccc; text-align:right;">
                </td>
              </tr>
              {% endfor %}
            {% else %}
              {# ðŸ”´ AJOUTÃ‰ : Affiche 2 lignes vides si on est en mode crÃ©ation #}
              {% for _ in range(2) %}
                <tr>
                  <td class="accounts-col">
                    <select name="num_compte[]" onchange="onAccountChange(this)">
                      <option value="">_SÃ©lectionner_</option>
                      {% for account in accounts %}
                        <option value="{{ account.num_compte }}" data-intitule="{{ account.intitule }}">
                          {{ account.num_compte }} â€“ {{ account.intitule }}
                        </option>
                      {% endfor %}
                    </select>
                  </td>
                  <td>
                    <input type="text" name="intitule[]" readonly value="" style="background:#fff; border:1px solid #ccc;">
                  </td>
                  <td>
                    <input type="text" name="debit[]" placeholder="0,00" style="background:#fff; border:1px solid #ccc; text-align:right;">
                  </td>
                  <td>
                    <input type="text" name="credit[]" placeholder="0,00" style="background:#fff; border:1px solid #ccc; text-align:right;">
                  </td>
                </tr>
              {% endfor %}
            {% endif %}
          </tbody>

        </table>
        <div style="width:100%; text-align:left; margin:28px 0 16px 0;">
          <button type="button"
                  class="action-btn"
                  onclick="addRow()"
                  style="height:40px; width:160px; font-size:18px; border-radius:8px; cursor:pointer;">
            Ajouter +
          </button>
        </div>

        <table style="margin-top: 10px; width: 100%;">
          <colgroup>
            <col class="col-compte">
            <col class="col-intitule">
            <col class="col-debit">
            <col class="col-credit">
          </colgroup>
          <tr class="total-row">
            <td colspan="1" style="text-align:left; border-right:none;">Total</td>
            <td style="border-left:none; border-right:none;"></td>
            <td style="text-align:right;">
              <input
                type="text"
                id="total_debit"
                name="total_debit"
                value="0,00"
                readonly
                style="width:100%; height:2.8em; box-sizing:border-box; padding:0 6px; background:#fff !important; border:1px solid #000; text-align:right;" />
            </td>
            <td style="text-align:right;">
              <input
                type="text"
                id="total_credit"
                name="total_credit"
                value="0,00"
                readonly
                style="width:100%; height:2.8em; box-sizing:border-box; padding:0 6px; background:#fff !important; border:1px solid #000; text-align:right;" />
            </td>
          </tr>
        </table>
      </div>
    </form>
  </div>

  <script>
    const accounts = JSON.parse(
      document.getElementById('accounts-data').textContent
    ).map(a => ({
      num_compte : (a['num_compte'] ?? a['NÂ° compte'] ?? '').trim(),
      intitule   : (a['intitule']   ?? a['IntitulÃ© du compte'] ?? '').trim()
    }));

    function addRow () {
      const tbody  = document.querySelector('#ecritures_table tbody');
      let opts = '<option value="" data-intitule="">_SÃ©lectionner_</option>';
      accounts.forEach(acc => {
        opts += `<option value="${acc.num_compte}" data-intitule="${acc.intitule}">
                  ${acc.num_compte} â€“ ${acc.intitule}
                </option>`;
      });
      const row = document.createElement('tr');
      row.innerHTML = `
        <td class="accounts-col">
          <select name="num_compte[]" onchange="onAccountChange(this)">
            ${opts}
          </select>
        </td>
        <td><input type="text" name="intitule[]" readonly style="background:#fff; border:1px solid #ccc;"></td>
        <td><input type="text" name="debit[]" placeholder="0,00" style="background:#fff; border:1px solid #ccc; text-align:right;"></td>
        <td><input type="text" name="credit[]" placeholder="0,00" style="background:#fff; border:1px solid #ccc; text-align:right;"></td>
      `;
      tbody.appendChild(row);
    }

    function recalcTotals() {
      const debits  = [...document.querySelectorAll('input[name="debit[]"]')];
      const credits = [...document.querySelectorAll('input[name="credit[]"]')];
      const totalD = debits.reduce((s, i) => s + parseFloat(i.value || 0), 0);
      const totalC = credits.reduce((s, i) => s + parseFloat(i.value || 0), 0);
      document.getElementById('total_debit').value  = totalD.toFixed(2);
      document.getElementById('total_credit').value = totalC.toFixed(2);
    }

    document.addEventListener('input', e => {
      if (e.target.name === 'debit[]' || e.target.name === 'credit[]') recalcTotals();
    });

    function onAccountChange (select) {
      const input = select.closest('tr').querySelector('input[name="intitule[]"]');
      const opt   = select.selectedOptions[0];
      input.value = opt ? (opt.dataset.intitule || '') : '';
    }

    document.getElementById('btn-create').addEventListener('click', () => {
      const form = document.querySelector('form');
      const data = new FormData(form);
      const totalD = parseFloat(document.getElementById('total_debit').value.replace(',', '.')) || 0;
      const totalC = parseFloat(document.getElementById('total_credit').value.replace(',', '.')) || 0;
      if (totalD !== totalC) {
        alert('â›” Totaux dÃ©sÃ©quilibrÃ©s : DÃ©bit â‰  CrÃ©dit');
        return;
      }
      fetch('{{ url_for("submit_ecriture_man") }}', {
        method: 'POST',
        body  : data
      })
      .then(r => r.json())
      .then(resp => {
        if (resp.success) {
          alert(`Ã‰criture nÂ° ${resp.num_ecriture} enregistrÃ©e âœ…`);
          form.reset();
          const tbody = document.querySelector('#ecritures_table tbody');
          tbody.innerHTML = tbody.firstElementChild.outerHTML;
          recalcTotals();
        } else {
          alert("â›” Impossible d'enregistrer : " + resp.reason);
        }
      })
      .catch(err => alert('Erreur rÃ©seau : ' + err));
    });

      document.addEventListener('DOMContentLoaded', function() {
      recalcTotals();
    });

    document.querySelectorAll('input[name="debit[]"], input[name="credit[]"]').forEach(input => {
      input.addEventListener('blur', function() {
        if (this.value && !isNaN(this.value.replace(',', '.'))) {
          let val = parseFloat(this.value.replace(',', '.'));
          this.value = val.toFixed(2);  // ðŸ”´ Affiche avec 2 dÃ©cimales et point
        }
      });
    });
  </script>
</body>
</html>
